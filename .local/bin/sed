#!/usr/bin/env python3
"""
Minimal sed shim for environments where sed is missing.
Supports:
  sed -i 's/old/new/[g]' file
  sed 's/old/new/[g]' file
This is NOT a full sed implementation—only what Odoo entrypoints need.
"""

import sys, re, os, tempfile
from shutil import move

def fail(msg):
    print(msg, file=sys.stderr)
    sys.exit(2)

def parse(expr):
    # Expecting s/old/new/g or s|old|new|
    if not expr.startswith("s"):
        return None
    delim = expr[1]
    parts = expr.split(delim)
    if len(parts) < 4:
        return None
    _, old, new, flags = parts[:4]
    count = 0 if "g" in flags else 1
    return old, new, count

def substitute(line, old, new, count):
    try:
        return re.sub(old, new, line, count=count)
    except re.error:
        # fallback: literal replace
        if count == 0:
            return line.replace(old, new)
        return line.replace(old, new, count)

def process(path, old, new, count, inplace):
    if not os.path.exists(path):
        fail(f"sed: {path}: No such file or directory")

    if inplace:
        fd, tmp = tempfile.mkstemp(dir=os.path.dirname(path))
        with os.fdopen(fd, "w", encoding="utf-8") as out:
            with open(path, "r", encoding="utf-8", errors="surrogateescape") as f:
                for ln in f:
                    out.write(substitute(ln, old, new, count))
        move(tmp, path)
    else:
        with open(path, "r", encoding="utf-8", errors="surrogateescape") as f:
            for ln in f:
                sys.stdout.write(substitute(ln, old, new, count))

def main(argv):
    if not argv:
        fail("Usage: sed [-i] 's/old/new/[g]' file ...")

    inplace = False
    if argv[0] == "-i":
        inplace = True
        argv = argv[1:]
        if len(argv) < 2:
            fail("Missing expression or file")

    expr = argv[0]
    files = argv[1:]

    parsed = parse(expr)
    if not parsed:
        fail("Only simple substitution expressions supported: s/old/new/[g]")

    old, new, count = parsed

    for f in files:
        process(f, old, new, count, inplace)

if __name__ == "__main__":
    try:
        main(sys.argv[1:])
    except BrokenPipeError:
        pass
